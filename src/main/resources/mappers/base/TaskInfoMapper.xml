<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.religion.zhiyun.task.dao.TaskInfoMapper">

    <insert id="addTask">
        insert into rm_task_info(
            TASK_NAME,
            TASK_CONTENT,
            END_TIME,
            REL_VENUES_ID,
            EMERGENCY_LEVEL,
            TASK_PICTURE,
            TASK_VIDEO,
            LAUNCH_PERSON,
            HANDLE_PERSON,
            HANDLE_RESULTS,
            HANDLE_TIME,
            TASK_TYPE,
            PROC_INST_ID,
            FLOW_TYPE,
            LAUNCH_TIME,
            REL_EVENT_ID
        )
        values (
            #{taskName},
            #{taskContent},
            #{endTime},
            #{relVenuesId},
            #{emergencyLevel},
            #{taskPicture},
            #{taskVideo},
            #{launchPerson},
            #{handlePerson},
            #{handleResults},
            #{handleTime},
            #{taskType},
            #{procInstId},
            #{flowType},
            #{launchTime},
            #{relEventId}
        )
    </insert>

    <update id="updateTask" >
        update rm_task_info t
            set t.HANDLE_PERSON=#{handlePerson},
            t.HANDLE_RESULTS=#{handleResults},
            t.HANDLE_TIME=#{handleTime}
        where PROC_INST_ID=#{procInstId}
    </update>

    <sql id="taskColumn">
        TASK_NAME as taskName,
        TASK_CONTENT as taskContent,
        END_TIME as endTime,
        REL_VENUES_ID as relVenuesId,
        EMERGENCY_LEVEL as emergencyLevel,
        TASK_PICTURE as taskPicture,
        TASK_VIDEO as taskVideo,
        LAUNCH_PERSON as launchPerson,
        HANDLE_PERSON as handlePerson,
        HANDLE_RESULTS as handleResults,
        HANDLE_TIME as handleTime,
        TASK_TYPE as taskType,
        PROC_INST_ID as procInstId
    </sql>

    <select id="queryTaskCommon" resultType="map">
        select
            case task.num
            when 1 then '任务发起'
            when 2 then '任务处理节点1'
            when 3 then '任务处理节点2'
            when 4 then '任务处理节点3'
            when 5 then '任务处理节点4'
            when 6 then '任务处理节点5'
            end as jieDian,
            task.handleTime,
            task.message,
            task.taskNm
        from(
            select
                @rownum := @rownum +1 as num,
                DATE_FORMAT(co.TIME_,'%Y-%m-%d %H:%i:%s') as handleTime,
                co.MESSAGE_ as message,
                case when us.USER_NM is not null then us.USER_NM
                else u.MANAGER_CN_NM
                end as taskNm
            from act_hi_identitylink ti
            left join act_hi_comment  co on ti.USER_ID_=co.USER_ID_ and ti.PROC_INST_ID_=co.PROC_INST_ID_
            left join rm_sys_user_info us on us.USER_MOBILE=ti.USER_ID_
            left join rm_venues_manager_info u on u.MANAGER_MOBILE=ti.USER_ID_
            join (SELECT  @rownum := 0) r
            where ti.PROC_INST_ID_=#{procInstId}
            order by co.TIME_ desc
        )task
    </select>

    <select id="getTaskCommon" resultType="map">
        select
        handleTime,message,taskNm,actId
        from
        ((select
            DATE_FORMAT(ti.END_TIME_,'%Y-%m-%d %H:%i:%s') as handleTime,
            '' as message,
            if(us.USER_NM is not null,
            CONCAT(us.USER_NM,'(',(select r.ROLE_NM from rm_sys_role r where r.ROLE_ID=us.IDENTITY),')'),
            if(u.MANAGER_CN_NM is not null,
            CONCAT(u.MANAGER_CN_NM,'(场所管理人员)'),
            ti.ASSIGNEE_ )) as taskNm,
            ti.PROC_INST_ID_ as id,
            ti.START_TIME_,
            ti.act_id_ as actId
        from act_hi_actinst ti
        left join rm_sys_user_info us on us.USER_MOBILE=ti.ASSIGNEE_
        left join rm_venues_manager_info u on u.MANAGER_MOBILE=ti.ASSIGNEE_
        where ti.ACT_TYPE_='startEvent'
        and ti.PROC_INST_ID_=#{procInstId})
        union all
        (select
            DATE_FORMAT(ti.END_TIME_,'%Y-%m-%d %H:%i:%s') as handleTime,
            co.MESSAGE_ as message,
            if(us.USER_NM is not null,
            CONCAT(us.USER_NM,'(',(select r.ROLE_NM from rm_sys_role r where r.ROLE_ID=us.IDENTITY),')'),
            if(u.MANAGER_CN_NM is not null,
            CONCAT(u.MANAGER_CN_NM,'(场所管理人员)'),
            ti.ASSIGNEE_  )) as taskNm,
            ti.PROC_INST_ID_ as id,
            ti.START_TIME_,
            ti.act_id_ as actId
        from act_hi_actinst ti
        join act_hi_comment  co on ti.ASSIGNEE_=co.USER_ID_ and ti.PROC_INST_ID_=co.PROC_INST_ID_
        left join rm_sys_user_info us on us.USER_MOBILE=ti.ASSIGNEE_
        left join rm_venues_manager_info u on u.MANAGER_MOBILE=ti.ASSIGNEE_
        where ti.PROC_INST_ID_=#{procInstId})
        union all
        (select
            DATE_FORMAT(ti.END_TIME_,'%Y-%m-%d %H:%i:%s') as handleTime,
            '' as message,
            '' as taskNm,
            ti.PROC_INST_ID_ as id,
            '',
            ti.act_id_ as actId
        from act_hi_actinst ti
        left join rm_sys_user_info us on us.USER_MOBILE=ti.ASSIGNEE_
        left join rm_venues_manager_info u on u.MANAGER_MOBILE=ti.ASSIGNEE_
        where ti.END_TIME_ is null
        and ti.PROC_INST_ID_=#{procInstId}
        group by ti.PROC_INST_ID_,ti.END_TIME_
        )
        ) task
        where task.taskNm is not null

    </select>

    <select id="getTaskSend" resultType="map">
        select
            GROUP_CONCAT(if(hus.USER_NM is not null,
            CONCAT(hus.USER_NM,'(',(select r.ROLE_NM from rm_sys_role r where r.ROLE_ID=hus.IDENTITY),')'),
            if(hu.MANAGER_CN_NM is not null,
            CONCAT(hu.MANAGER_CN_NM,'(场所管理人员)'),
            thi.ASSIGNEE_ ))) as sendNames,
            min(DATE_FORMAT(thi.START_TIME_,'%Y-%m-%d %H:%i:%s') ) as sendTime
        from act_hi_actinst thi
        left join rm_sys_user_info hus on hus.USER_MOBILE=thi.ASSIGNEE_
        left join rm_venues_manager_info hu on hu.MANAGER_MOBILE=thi.ASSIGNEE_
        where thi.act_id_=#{actId} and thi.PROC_INST_ID_=#{procInstId}
    </select>

    <select id="queryTasks" resultType="map">
        SELECT
            ta.TASK_NAME as taskName,
            ve.VENUES_NAME as venuesAddres,
            di.DICT_CN_DESC as flowType,
            DATE_FORMAT(ta.END_TIME,'%Y-%m-%d %H:%i:%s') as endTime,
            case when ta.FLOW_TYPE in ('03','04','06') then u.MANAGER_CN_NM else us.USER_NM end as launchPerson,
            case ta.HANDLE_RESULTS
                when '0' then '未解决'
                when '1' then '已解决'
                else ta.HANDLE_RESULTS
            end as handleResults,
            case when ta.HANDLE_TIME is null then '进行中' else '已结束' end as statTask,
            ta.PROC_INST_ID as procInstId
        FROM rm_task_info ta
        left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
        left join rm_sys_dict di on ta.FLOW_TYPE=di.DICT_CD and di.DICT_TYPE_CD='1003'
        left join rm_sys_user_info us on us.USER_MOBILE=ta.LAUNCH_PERSON
        left join rm_venues_manager_info u on u.MANAGER_MOBILE=ta.LAUNCH_PERSON
        left join act_hi_identitylink ac on ac.PROC_INST_ID_ = ta.PROC_INST_ID and ac.TYPE_='starter'
        where 1=1
        <if test="vo.searchThree != null and vo.searchThree != ''">
            and ac.USER_ID_=#{vo.searchThree}
        </if>
        <if test="vo.searchOne != null and vo.searchOne != ''">
            and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
        </if>
        <if test="vo.searchTwo != null and vo.searchTwo != ''">
            and ve.VENUES_NAME  LIKE CONCAT('%',#{vo.searchTwo},'%')
        </if>
        order by ta.HANDLE_RESULTS,ta.END_TIME
        limit #{vo.page},#{vo.size}
    </select>

    <select id="queryTasksTotal" resultType="long">
        SELECT
            count(ta.TASK_ID)
        FROM rm_task_info ta
        left join act_hi_identitylink ac on ac.PROC_INST_ID_ = ta.PROC_INST_ID and ac.TYPE_='starter'
        where 1=1
        <if test="vo.searchThree != null and vo.searchThree != ''">
            and ac.USER_ID_=#{vo.searchThree}
        </if>
        <if test="vo.searchOne != null and vo.searchOne != ''">
            and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
        </if>
        <if test="vo.searchTwo != null and vo.searchTwo != ''">
            and ve.VENUES_NAME  LIKE CONCAT('%',#{vo.searchTwo},'%')
        </if>
    </select>

    <select id="getTaskNum" resultType="map">
        select
            sum(allSum) as allSum,sum(startSum) as startSum,sum(executeNum) as executeNum
        from (
            (
                select
                    count(ta.PROC_INST_ID)  as allSum,count(PROC_INST_ID) AS startSum, 0 AS executeNum
                from rm_task_info ta
                where 1=1
                <if test="loginNm!=null and loginNm!=''">
                    and ta.LAUNCH_PERSON = #{loginNm}
                </if>
            )union all(
                select
                    count(co.PROC_INST_ID_) as allSum, 0 AS startSum  ,count(co.PROC_INST_ID_) AS executeNum
                from act_hi_comment co
                where 1=1
                <if test="loginNm!=null and loginNm!=''">
                    and co.USER_ID_ = #{loginNm}
                </if>
            )union all(
                select
                    count(ac.PROC_INST_ID_) as allSum, 0 AS startSum   ,count(ac.PROC_INST_ID_) AS executeNum
                from act_hi_actinst ac
                where  ac.END_TIME_ is null
                <if test="loginNm!=null and loginNm!=''">
                    and ac.ASSIGNEE_ = #{loginNm}
                </if>
            )
        ) al
    </select>
    <select id="queryByInstId" resultType="map">
        select
            ta.TASK_NAME as taskName,
            ta.TASK_CONTENT as taskContent,
            DATE_FORMAT(ta.END_TIME ,'%Y-%m-%d %H:%i:%s') as endTime,
            ve.VENUES_ADDRES as venuesAddres,
            case ta.EMERGENCY_LEVEL
            when '01' then '紧急'
            when '02' then '普通'
            else ta.EMERGENCY_LEVEL
            end as emergencyLevel,
            ta.EMERGENCY_LEVEL as emergencyLevelCode,
            case when FLOW_TYPE in ('06','04','03') then ma.MANAGER_CN_NM
            else us.USER_NM
            end as launchPerson,
            DATE_FORMAT(ta.LAUNCH_TIME ,'%Y-%m-%d %H:%i:%s') as launchTime,
            DATE_FORMAT(ta.HANDLE_TIME ,'%Y-%m-%d %H:%i:%s') as handleTime,
            ta.HANDLE_RESULTS as handleResults,
            ta.PROC_INST_ID as procInstId
        from rm_task_info ta
        left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
        left join rm_sys_user_info us on ta.LAUNCH_PERSON=us.USER_MOBILE
        left join rm_venues_manager_info ma on ma.MANAGER_MOBILE=ta.LAUNCH_PERSON
        where ta.PROC_INST_ID in
        <foreach collection="idList" item="procInstId" index="index" open="(" close=")" separator=",">
            #{procInstId}
        </foreach>
        order by ta.END_TIME desc
        limit #{page},#{size}

    </select>

    <select id="getProcdef" resultType="com.religion.zhiyun.task.entity.ProcdefEntity">
        select
            pro.NAME_ as name,
            pro.DESCRIPTION_ as description,
            pro.KEY_  as taskKey,
            pro.VERSION_ as version,
            pro.RESOURCE_NAME_ as resourceName
        from act_re_procdef pro
        where 1=1
        <if test="taskName != null and taskName != ''">
            and pro.NAME_ LIKE CONCAT('%',#{taskName},'%')
        </if>
        order by pro.KEY_ ,pro.VERSION_ desc
        limit #{page},#{size}
    </select>

    <insert id="addFill">
        insert into rm_filing_info(
            TASK_NAME,
            TASK_CONTENT,
            REL_VENUES_ID,
            TASK_PICTURE,
            TASK_VIDEO,
            LAUNCH_PERSON,
            LAUNCH_TIME,
            HANDLE_PERSON,
            HANDLE_RESULTS,
            HANDLE_TIME,
            PROC_INST_ID,
            PART_NUM,
            RESPONSIBLE_PERSON,
            TASK_TIME,
            FILING_STATUS
        )
        values (
            #{taskName},
            #{taskContent},
            #{relVenuesId},
            #{taskPicture},
            #{taskVideo},
            #{launchPerson},
            #{launchTime},
            #{handlePerson},
            #{handleResults},
            #{handleTime},
            #{procInstId},
            #{partNum},
            #{responsiblePerson},
            #{taskTime},
            #{filingStatus}
        )
    </insert>

    <update id="updateFill" >
        update rm_filing_info t
        set t.HANDLE_PERSON=#{handlePerson},
            t.HANDLE_RESULTS=#{handleResults},
            t.HANDLE_TIME=#{handleTime},
            t.FILING_STATUS='02'
        where t.PROC_INST_ID=#{procInstId}
    </update>

    <select id="getIssuedUsers" resultType="String">
        select
            loginNm
        from
        (
            (select
                f.USER_MOBILE AS loginNm,IDENTITY
            from rm_sys_user_info f
            where f.VALID_IND='1'
            and f.IDENTITY in
            <foreach collection="identityArr" item="identity" index="index" open="(" close=")" separator=",">
                #{identity}
            </foreach>
            <if test="province != null and province != ''">
                and f.province=#{province}
            </if>
            <if test="city != null and city != ''">
                and f.city=#{city}
            </if>
            <if test="area != null and area != ''">
                and f.area=#{area}
            </if>
            <if test="town != null and town != ''">
                and f.town=#{town}
            </if>
        )union all(
            select
                f.USER_MOBILE AS loginNm,IDENTITY
            from rm_sys_user_info f
            where f.VALID_IND='1'
            and f.IDENTITY in ('10000006','10000007')
            <if test="relVenuesId != null and relVenuesId != ''">
                and f.REL_VENUES_ID LIKE CONCAT('%',#{relVenuesId},'%')
            </if>
            )
        ) uu order by uu.IDENTITY
    </select>

    <select id="getJieGanUsers" resultType="String">
        select
           g.USER_MOBILE as userMobile
        from rm_sys_user_info  g
        left join rm_sys_user_info u on g.town=u.town and u.IDENTITY='10000006'
        where g.VALID_IND='1'
        and g.IDENTITY ='10000005'
        <if test="relVenuesId!=null and relVenuesId!=''">
            and u.REL_VENUES_ID LIKE CONCAT('%',#{relVenuesId},'%')
        </if>
        order by g.user_id
    </select>

    <select id="getFillHistory" resultType="map">
        select
            t.FILING_ID as filingId,
            t.TASK_NAME as taskName,
            DATE_FORMAT(t.TASK_TIME,'%Y-%m-%d %H:%i:%s') as taskTime,
            v.VENUES_NAME as venuesName,
            t.PART_NUM as partNum,
            t.RESPONSIBLE_PERSON as responsiblePerson,
            t.TASK_CONTENT as taskContent
        from rm_filing_info t
        left join rm_venues_info v on v.VENUES_ID =t.REL_VENUES_ID
        left join rm_venues_manager_info m on v.RESPONSIBLE_PERSON=m.MANAGER_ID
        where t.FILING_STATUS='02'
        and m.MANAGER_MOBILE=#{login}
        <if test="search!=null and search!=''">
            AND  (
            t.TASK_NAME LIKE CONCAT('%',#{search},'%')
            or t.TASK_CONTENT LIKE CONCAT('%',#{search},'%')
            or v.VENUES_NAME LIKE CONCAT('%',#{search},'%')
            )
        </if>
        order by t.TASK_TIME desc
        limit #{page},#{size}

    </select>

    <select id="getFillHisDetail" resultType="map">
        select
            t.FILING_ID as filingId,
            t.TASK_NAME as taskName,
            DATE_FORMAT(t.TASK_TIME,'%Y-%m-%d %H:%i:%s') as taskTime,
            v.VENUES_NAME as venuesName,
            t.PART_NUM as partNum,
            t.TASK_CONTENT as taskContent,
            m.MANAGER_CN_NM as responsiblePerson,
            t.TASK_PICTURE as taskPicture

        from rm_filing_info t
        left join rm_venues_info v on v.VENUES_ID =t.REL_VENUES_ID
        left join rm_venues_manager_info m on v.RESPONSIBLE_PERSON=m.MANAGER_ID
        where t.FILING_ID =#{filingId}
    </select>

    <select id="getMonitorTask" resultType="map">
        select
            v.VENUES_ADDRES as venuesAddres,
            ta.TASK_CONTENT as taskContent,
            DATE_FORMAT(ta.END_TIME,'%Y-%m-%d %H:%i:%s') as endTime,
            ta.LAUNCH_PERSON as launchPerson,
            ta.PROC_INST_ID as procInstId
        from rm_task_info ta
        left join rm_venues_info v on v.VENUES_ID =ta.REL_VENUES_ID
        where ta.TASK_ID=#{taskId}
    </select>

    <select id="getTaskMonth" resultType="java.util.Map">
        SELECT  tm.tmDate as date,
                IFNULL(comm.commTotal,0) as handleTotal,
                IFNULL(act.actTotal,0) as launchTotal
        FROM (
            SELECT DATE_FORMAT(date_add(CURDATE(), INTERVAL i MONTH),'%Y-%m')  AS tmDate
            FROM num a where a.i >#{num} and type='month'
        ) tm
        left join(
            select
                DATE_FORMAT(co.TIME_,'%Y-%m') as evDate,
                count(co.ID_) as commTotal
            from act_hi_comment  co
            left join rm_task_info ta on co.PROC_INST_ID_=ta.PROC_INST_ID
            where DATE_FORMAT(co.TIME_,'%Y-%m-%d') > date_add(CURDATE(), interval 31*#{num} day)
            and ta.HANDLE_TIME is not null
            <if test="login!=null and login!=''">
                and co.USER_ID_= #{login}
            </if>
            group by evDate
        ) comm on comm.evDate=tm.tmDate
        left join (
            select DATE_FORMAT(ac.END_TIME_,'%Y-%m') as evDate,
                count(ac.ID_) as actTotal
            FROM act_hi_actinst ac
            left join rm_task_info ta on ac.PROC_INST_ID_=ta.PROC_INST_ID
            where DATE_FORMAT(ac.END_TIME_,'%Y-%m-%d') > date_add(CURDATE(), interval 31*#{num} day)
            and ac.ACT_TYPE_='startEvent'
            and ta.HANDLE_TIME is not null
            <if test="login!=null and login!=''">
                and ac.ASSIGNEE_=#{login}
            </if>
            group by evDate
        )act on act.evDate=tm.tmDate
        ORDER BY tm.tmDate
    </select>

    <select id="getTaskDay" resultType="java.util.Map">
        SELECT  DATE_FORMAT(tm.tmDate,'%Y-%m-%d') as date,
                IFNULL(comm.commTotal,0) as handleTotal,
                IFNULL(act.actTotal,0) as launchTotal
        FROM(
            SELECT date_add(CURDATE(), interval i day) AS tmDate FROM num a where a.i > #{num} and type='day'
        ) tm
        left join(
            select
                DATE_FORMAT(co.TIME_,'%Y-%m-%d') as evDate,
                count(co.ID_) as commTotal
            from act_hi_comment  co
            left join rm_task_info ta on co.PROC_INST_ID_=ta.PROC_INST_ID
            where DATE_FORMAT(co.TIME_,'%Y-%m-%d') > date_add(CURDATE(), interval #{num} day)
            and ta.HANDLE_TIME is not null
            <if test="login!=null and login!=''">
                and co.USER_ID_= #{login}
            </if>
            group by evDate
        ) comm on comm.evDate=tm.tmDate
        left join (
            select DATE_FORMAT(ac.END_TIME_,'%Y-%m-%d') as evDate,
                count(ac.ID_) as actTotal
            FROM act_hi_actinst ac
            left join rm_task_info ta on ac.PROC_INST_ID_=ta.PROC_INST_ID
            where DATE_FORMAT(ac.END_TIME_,'%Y-%m-%d') > date_add(CURDATE(), interval #{num} day)
            and ac.ACT_TYPE_='startEvent'
            and ta.HANDLE_TIME is not null
            <if test="login!=null and login!=''">
                and ac.ASSIGNEE_=#{login}
            </if>
            group by evDate
        )act on act.evDate=tm.tmDate
        ORDER BY tm.tmDate
    </select>

    <select id="getTaskWeek" resultType="java.util.Map">
        SELECT (@rownum := @rownum + 1) AS date,
            IFNULL(comm.tots,0) as handleTotal,
            IFNULL(act.tots,0) as launchTotal
        FROM(
            SELECT i AS tmDate FROM num a where a.i > #{num} and type='day'
        ) tm
        LEFT JOIN (
            SELECT  ors.weeks,
                IFNULL(ors.tot,0) as tots
            from (
                (
                    select  WEEK(co.TIME_,3) -(WEEK(CURDATE(),3)) as weeks,
                            count(co.ID_) as tot
                    from act_hi_comment  co
                    left join rm_task_info ta on co.PROC_INST_ID_=ta.PROC_INST_ID
                    where DATE_FORMAT(co.TIME_,'%Y')=DATE_FORMAT(CURDATE(),'%Y')
                    and DATE_FORMAT(co.TIME_,'%Y-%m-%d') > date_add(CURDATE(), interval (#{num}+1)*7 day)
                    and ta.HANDLE_TIME is not null
                    <if test="login!=null and login!=''">
                        and co.USER_ID_= #{login}
                    </if>
                    GROUP BY weeks
                    ORDER BY weeks
                )union all(
                    select (WEEK(co.TIME_,3) -(select WEEK(num.REMARK,3) as h from num where type='lastYear') - (WEEK(CURDATE(),3))) as weeks,
                            count(co.ID_) as tot
                    from act_hi_comment  co
                    left join rm_task_info ta on co.PROC_INST_ID_=ta.PROC_INST_ID
                    where   DATE_FORMAT(co.TIME_,'%Y')=DATE_FORMAT(CURDATE(),'%Y')-1
                    and DATE_FORMAT(co.TIME_,'%Y-%m-%d') > (select date_add(subdate(curdate(),date_format(curdate(),'%w')-1),interval 7*(#{num}+1)-1 day)from dual)
                    and ta.HANDLE_TIME is not null
                    <if test="login!=null and login!=''">
                        and co.USER_ID_= #{login}
                    </if>
                    GROUP BY weeks
                    ORDER BY weeks desc
                )
            ) ors
        )comm on tm.tmDate=comm.weeks
        LEFT JOIN (
            SELECT  ors.weeks,
            IFNULL(ors.tot,0) as tots
            from (
                (
                    select  WEEK(ac.END_TIME_,3) -(WEEK(CURDATE(),3)) as weeks,
                        count(ac.ID_) as tot
                    from act_hi_actinst  ac
                    left join rm_task_info ta on ac.PROC_INST_ID_=ta.PROC_INST_ID
                    where DATE_FORMAT(ac.END_TIME_,'%Y')=DATE_FORMAT(CURDATE(),'%Y')
                    and DATE_FORMAT(ac.END_TIME_,'%Y-%m-%d') > date_add(CURDATE(), interval (#{num}+1)*7 day)
                    and ac.ACT_TYPE_='startEvent'
                    and ta.HANDLE_TIME is not null
                    <if test="login!=null and login!=''">
                        and ac.ASSIGNEE_= #{login}
                    </if>
                    GROUP BY weeks
                    ORDER BY weeks
                )union all(
                    select (WEEK(ac.END_TIME_,3) -(select WEEK(num.REMARK,3) as h from num where type='lastYear') - (WEEK(CURDATE(),3))) as weeks,
                            count(ac.ID_) as tot
                    from act_hi_actinst  ac
                    left join rm_task_info ta on ac.PROC_INST_ID_=ta.PROC_INST_ID
                    where DATE_FORMAT(ac.END_TIME_,'%Y')=DATE_FORMAT(CURDATE(),'%Y')-1
                    and DATE_FORMAT(ac.END_TIME_,'%Y-%m-%d') > (select date_add(subdate(curdate(),date_format(curdate(),'%w')-1),interval 7*(#{num}+1)-1 day)from dual)
                    and ac.ACT_TYPE_='startEvent'
                    and ta.HANDLE_TIME is not null
                    <if test="login!=null and login!=''">
                        and ac.ASSIGNEE_= #{login}
                    </if>
                    GROUP BY weeks
                    ORDER BY weeks desc
                )
            ) ors
        )act on tm.tmDate=act.weeks
        join (SELECT @rownum := 0) AS rn
        order by tm.tmDate
    </select>

    <select id="getTaskContent" resultType="String">
        select
            TASK_CONTENT  as taskContent
        from rm_task_info ta
        where ta.PROC_INST_ID = #{procInstId}
    </select>

    <select id="getTaskGather" resultType="map">
        select tm.tmDate,
                tm.REMARK as remarkDate,
                TRUNCATE(IFNULL(tt.total,0)/IFNULL(tt.avg,0),2) as ouHai,
                IFNULL(tt.dd,0) as myTotal

        FROM(
            SELECT date_add(CURDATE(), interval i day) AS tmDate,REMARK FROM num a where a.i >#{num} and type='taskDay'
        ) tm
        LEFT JOIN(
            select
                DATE_FORMAT(co.TIME_,'%Y-%m-%d') as evDate,
                count(co.ID_) as total,
                count(distinct co.USER_ID_) as avg,
                SUM(case when co.USER_ID_= #{handle}  then 1 else 0 END )as dd
            from act_hi_comment  co
            group by evDate
        ) tt on tm.tmDate= tt.evDate
    </select>

    <select id="getTaskAgvGather" resultType="map">
        SELECT  tm.tmDate as date,
                IFNULL(TRUNCATE(IFNULL(comm.commTotal,0)/IFNULL(comm.avg,0),2) ,0)as ouHai,
                IFNULL(comm.dd,0) as myTotal
        FROM (
            SELECT DATE_FORMAT(date_add(CURDATE(), INTERVAL i MONTH),'%Y-%m')  AS tmDate
            FROM num a where a.i >#{num} and type='month'
        ) tm
        left join(
            select
                DATE_FORMAT(co.TIME_,'%Y-%m') as evDate,
                (select count(u.USER_ID)
                    from rm_sys_user_info u
                    where u.area='330304'
                    and u.IDENTITY in
                    <foreach collection="identityArr" item="item" index="index" open="(" close=")" separator=",">
                        #{item}
                    </foreach>
                ) as avg,
                count(co.ID_) as commTotal,
                SUM(case when co.USER_ID_=#{handle} then 1 else 0 END )as dd
            from act_hi_comment  co
            left join rm_sys_user_info us on co.USER_ID_=us.USER_MOBILE
            left join rm_task_info ta on co.PROC_INST_ID_=ta.PROC_INST_ID
            where DATE_FORMAT(co.TIME_,'%Y-%m-%d') > date_add(CURDATE(), interval 31*#{num} day)
            and ta.HANDLE_TIME is not null
            and us.area='330304'
            and us.IDENTITY in
            <foreach collection="identityArr" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
            group by evDate
        ) comm on comm.evDate=tm.tmDate
        ORDER BY tm.tmDate
    </select>

    <select id="getMyLaunchTask" resultType="map">
        SELECT
            ta.TASK_NAME as taskName,
            case when ve.VENUES_NAME is not null then ve.VENUES_NAME
            else ''
            end as venuesName,
            case when ve.VENUES_ADDRES is not null then ve.VENUES_ADDRES
            else ''
            end as venuesAddres,
            case when ta.HANDLE_TIME is not null
            then  '已完成' else '待完成' end as statTask,
            ta.PROC_INST_ID as procInstId,
            DATE_FORMAT(ta.LAUNCH_TIME,'%Y-%m-%d %H:%i:%s') as taskTime,
            case ta.EMERGENCY_LEVEL when '01' then '紧急' when '02' then '普通' else ta.EMERGENCY_LEVEL end as emeLevelCn,
            ta.EMERGENCY_LEVEL as emeLevel,
            ta.FLOW_TYPE as flowType,
            if(u.USER_NM is not null, u.USER_NM,if(m.MANAGER_CN_NM is not null,m.MANAGER_CN_NM,ta.LAUNCH_PERSON )) as launchPerson,
            '330000' as province,
            '330300' as city,
            ve.area as area,
            case  ta.REL_VENUES_ID!=u.area
            when ta.REL_VENUES_ID=ve.VENUES_ID then ve.town
            when ve.VENUES_ID is null then ta.REL_VENUES_ID
            else ''
            end as town,
            TASK_CONTENT as taskContent
        FROM rm_task_info ta
        left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
        left join rm_sys_user_info u on u.USER_MOBILE=ta.LAUNCH_PERSON
        left join rm_venues_manager_info m on m.MANAGER_MOBILE=ta.LAUNCH_PERSON
        where 1=1
        <if test="vo.searchTwo!=null and vo.searchTwo!=''">
            and ta.LAUNCH_PERSON = #{vo.searchTwo}
        </if>
        <if test="vo.venues!=null and vo.venues!=''">
            and ve.VENUES_NAME LIKE CONCAT('%',#{vo.venues},'%')
        </if>
        <if test="vo.searchOne!=null and vo.searchOne!=''">
            and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
        </if>
        order by statTask desc,ta.EMERGENCY_LEVEL ,taskTime desc
        limit #{vo.page},#{vo.size}
    </select>

    <select id="getMyLaunchTaskTotal" resultType="long">
        select COUNT(ta.TASK_ID)
        from rm_task_info ta
        left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
        where 1=1
        <if test="vo.searchTwo!=null and vo.searchTwo!=''">
            and ta.LAUNCH_PERSON = #{vo.searchTwo}
        </if>
        <if test="vo.venues!=null and vo.venues!=''">
            and ve.VENUES_NAME LIKE CONCAT('%',#{vo.venues},'%')
        </if>
        <if test="vo.searchOne!=null and vo.searchOne!=''">
            and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
        </if>
    </select>

    <select id="getMyHandleTask" resultType="map">
        select al.*
        from
        ((
            SELECT
                ta.TASK_NAME as taskName,
                case when ve.VENUES_NAME is not null then ve.VENUES_NAME
                else ''
                end as venuesName,
                case when ve.VENUES_ADDRES is not null then ve.VENUES_ADDRES
                else ''
                end as venuesAddres,
                case when ta.HANDLE_TIME is not null
                then  '已完成' else '待完成' end as statTask,
                ta.PROC_INST_ID as procInstId,
                DATE_FORMAT(ta.LAUNCH_TIME,'%Y-%m-%d %H:%i:%s') as taskTime,
                case ta.EMERGENCY_LEVEL when '01' then '紧急' when '02' then '普通' else ta.EMERGENCY_LEVEL end as emeLevelCn,
                ta.EMERGENCY_LEVEL as emeLevel,
                ta.FLOW_TYPE as flowType,
                if(u.USER_NM is not null, u.USER_NM,if(m.MANAGER_CN_NM is not null,m.MANAGER_CN_NM,ta.LAUNCH_PERSON )) as launchPerson,
                '330000' as province,
                '330300' as city,
                ve.area as area,
                case  ta.REL_VENUES_ID!=u.area
                when ta.REL_VENUES_ID=ve.VENUES_ID then ve.town
                when ve.VENUES_ID is null then ta.REL_VENUES_ID
                else ''
                end as town,
                TASK_CONTENT as taskContent
            FROM rm_task_info ta
            left join act_hi_comment co on ta.PROC_INST_ID=co.PROC_INST_ID_
            left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
            left join rm_sys_user_info u on u.USER_MOBILE=ta.LAUNCH_PERSON
            left join rm_venues_manager_info m on m.MANAGER_MOBILE=ta.LAUNCH_PERSON
            where 1=1
            <if test="vo.searchTwo!=null and vo.searchTwo!=''">
                and co.USER_ID_ = #{vo.searchTwo}
            </if>
            <if test="vo.searchThree!=null and vo.searchThree!=''">
                and co.USER_ID_ = #{vo.searchThree}
            </if>
        )UNION ALL(
            SELECT
                ta.TASK_NAME as taskName,
                case when ve.VENUES_NAME is not null then ve.VENUES_NAME
                else ''
                end as venuesName,
                case when ve.VENUES_ADDRES is not null then ve.VENUES_ADDRES
                else ''
                end as venuesAddres,
                case when ta.HANDLE_TIME is not null
                then  '已完成' else '待完成' end as statTask,
                ta.PROC_INST_ID as procInstId,
                DATE_FORMAT(ta.LAUNCH_TIME,'%Y-%m-%d %H:%i:%s') as taskTime,
                case ta.EMERGENCY_LEVEL when '01' then '紧急' when '02' then '普通' else ta.EMERGENCY_LEVEL end as emeLevelCn,
                ta.EMERGENCY_LEVEL as emeLevel,
                ta.FLOW_TYPE as flowType,
                if(u.USER_NM is not null, u.USER_NM,if(m.MANAGER_CN_NM is not null,m.MANAGER_CN_NM,ta.LAUNCH_PERSON )) as launchPerson,
                '330000' as province,
                '330300' as city,
                ve.area as area,
                case  ta.REL_VENUES_ID!=u.area
                when ta.REL_VENUES_ID=ve.VENUES_ID then ve.town
                when ve.VENUES_ID is null then ta.REL_VENUES_ID
                else ''
                end as town,
                TASK_CONTENT as taskContent
            FROM rm_task_info ta
            left join  act_hi_actinst ac on ac.PROC_INST_ID_ = ta.PROC_INST_ID and ac.END_TIME_ is null
            left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
            left join rm_sys_user_info u on u.USER_MOBILE=ta.LAUNCH_PERSON
            left join rm_venues_manager_info m on m.MANAGER_MOBILE=ta.LAUNCH_PERSON
            where 1=1
            <if test="vo.searchTwo!=null and vo.searchTwo!=''">
               and ac.ASSIGNEE_ = #{vo.searchTwo}
            </if>
            )
        )al
        order by al.statTask desc,al.emeLevel ,al.taskTime desc
        limit #{vo.page},#{vo.size}
    </select>

    <select id="getMyHandleTotal" resultType="long">
        select count(al.PROC_INST_ID_)
        from (
            (select co.PROC_INST_ID_ from act_hi_comment co
            where 1=1
            <if test="vo.searchTwo!=null and vo.searchTwo!=''">
                and co.USER_ID_ = #{vo.searchTwo}
            </if>
            <if test="vo.searchThree!=null and vo.searchThree!=''">
                and co.USER_ID_ = #{vo.searchThree}
            </if>
            )union all
            (select ac.PROC_INST_ID_ from act_hi_actinst ac
            where  ac.END_TIME_ is null
            <if test="vo.searchTwo!=null and vo.searchTwo!=''">
                and ac.ASSIGNEE_ = #{vo.searchTwo}
            </if>
            )
        ) al
    </select>

    <select id="getMyTask" resultType="map">
        SELECT al.*
        FROM (
            (
            SELECT
                ta.TASK_NAME as taskName,
                case when ve.VENUES_NAME is not null then ve.VENUES_NAME
                else ''
                end as venuesName,
                case when ve.VENUES_ADDRES is not null then ve.VENUES_ADDRES
                else ''
                end as venuesAddres,
                case when ta.HANDLE_TIME is not null
                then  '已完成' else '待完成' end as statTask,
                ta.PROC_INST_ID as procInstId,
                DATE_FORMAT(ta.LAUNCH_TIME,'%Y-%m-%d %H:%i:%s') as taskTime,
                case ta.EMERGENCY_LEVEL when '01' then '紧急' when '02' then '普通' else ta.EMERGENCY_LEVEL end as emeLevelCn,
                ta.EMERGENCY_LEVEL as emeLevel,
                ta.FLOW_TYPE as flowType,
                if(u.USER_NM is not null, u.USER_NM,if(m.MANAGER_CN_NM is not null,m.MANAGER_CN_NM,ta.LAUNCH_PERSON )) as launchPerson,
                '330000' as province,
                '330300' as city,
                ve.area as area,
                case  ta.REL_VENUES_ID!=u.area
                when ta.REL_VENUES_ID=ve.VENUES_ID then ve.town
                when ve.VENUES_ID is null then ta.REL_VENUES_ID
                else ''
                end as town,
                TASK_CONTENT as taskContent
            FROM rm_task_info ta
            left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
            left join rm_sys_user_info u on u.USER_MOBILE=ta.LAUNCH_PERSON
            left join rm_venues_manager_info m on m.MANAGER_MOBILE=ta.LAUNCH_PERSON
            where 1=1
            <if test="vo.searchTwo!=null and vo.searchTwo!=''">
                and ta.LAUNCH_PERSON = #{vo.searchTwo}
            </if>
            <if test="vo.venues!=null and vo.venues!=''">
                and ve.VENUES_NAME LIKE CONCAT('%',#{vo.venues},'%')
            </if>
            <if test="vo.searchOne!=null and vo.searchOne!=''">
                and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
            </if>
        )union all(
            SELECT
                ta.TASK_NAME as taskName,
                case when ve.VENUES_NAME is not null then ve.VENUES_NAME
                else ''
                end as venuesName,
                case when ve.VENUES_ADDRES is not null then ve.VENUES_ADDRES
                else ''
                end as venuesAddres,
                case when ta.HANDLE_TIME is not null
                then  '已完成' else '待完成' end as statTask,
                ta.PROC_INST_ID as procInstId,
                DATE_FORMAT(ta.LAUNCH_TIME,'%Y-%m-%d %H:%i:%s') as taskTime,
                case ta.EMERGENCY_LEVEL when '01' then '紧急' when '02' then '普通' else ta.EMERGENCY_LEVEL end as emeLevelCn,
                ta.EMERGENCY_LEVEL as emeLevel,
                ta.FLOW_TYPE as flowType,
                if(u.USER_NM is not null, u.USER_NM,if(m.MANAGER_CN_NM is not null,m.MANAGER_CN_NM,ta.LAUNCH_PERSON )) as launchPerson,
                '330000' as province,
                '330300' as city,
                ve.area as area,
                case  ta.REL_VENUES_ID!=u.area
                when ta.REL_VENUES_ID=ve.VENUES_ID then ve.town
                when ve.VENUES_ID is null then ta.REL_VENUES_ID
                else ''
                end as town,
                TASK_CONTENT as taskContent
            FROM rm_task_info ta
            left join act_hi_comment co on ta.PROC_INST_ID=co.PROC_INST_ID_
            left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
            left join rm_sys_user_info u on u.USER_MOBILE=ta.LAUNCH_PERSON
            left join rm_venues_manager_info m on m.MANAGER_MOBILE=ta.LAUNCH_PERSON
            where 1=1
            <if test="vo.searchTwo!=null and vo.searchTwo!=''">
                and co.USER_ID_ = #{vo.searchTwo}
            </if>
            <if test="vo.venues!=null and vo.venues!=''">
                and ve.VENUES_NAME LIKE CONCAT('%',#{vo.venues},'%')
            </if>
            <if test="vo.searchOne!=null and vo.searchOne!=''">
                and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
            </if>
        )union all(
            SELECT
                ta.TASK_NAME as taskName,
                case when ve.VENUES_NAME is not null then ve.VENUES_NAME
                else ''
                end as venuesName,
                case when ve.VENUES_ADDRES is not null then ve.VENUES_ADDRES
                else ''
                end as venuesAddres,
                case when ta.HANDLE_TIME is not null
                then  '已完成' else '待完成' end as statTask,
                ta.PROC_INST_ID as procInstId,
                DATE_FORMAT(ta.LAUNCH_TIME,'%Y-%m-%d %H:%i:%s') as taskTime,
                case ta.EMERGENCY_LEVEL when '01' then '紧急' when '02' then '普通' else ta.EMERGENCY_LEVEL end as emeLevelCn,
                ta.EMERGENCY_LEVEL as emeLevel,
                ta.FLOW_TYPE as flowType,
                if(u.USER_NM is not null, u.USER_NM,if(m.MANAGER_CN_NM is not null,m.MANAGER_CN_NM,ta.LAUNCH_PERSON )) as launchPerson,
                '330000' as province,
                '330300' as city,
                ve.area as area,
                case  ta.REL_VENUES_ID!=u.area
                when ta.REL_VENUES_ID=ve.VENUES_ID then ve.town
                when ve.VENUES_ID is null then ta.REL_VENUES_ID
                else ''
                end as town,
                TASK_CONTENT as taskContent
            FROM rm_task_info ta
            left join  act_hi_actinst ac on ac.PROC_INST_ID_ = ta.PROC_INST_ID and ac.END_TIME_ is null
            left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
            left join rm_sys_user_info u on u.USER_MOBILE=ta.LAUNCH_PERSON
            left join rm_venues_manager_info m on m.MANAGER_MOBILE=ta.LAUNCH_PERSON
            where 1=1
            <if test="vo.searchTwo!=null and vo.searchTwo!=''">
                and ac.ASSIGNEE_ = #{vo.searchTwo}
            </if>
            <if test="vo.venues!=null and vo.venues!=''">
                and ve.VENUES_NAME LIKE CONCAT('%',#{vo.venues},'%')
            </if>
            <if test="vo.searchOne!=null and vo.searchOne!=''">
                and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
            </if>
        )
        )al
        order by al.statTask desc,al.emeLevel ,al.taskTime desc
        limit #{vo.page},#{vo.size}
    </select>

    <select id="getMyTaskTotal" resultType="long">
        select count(al.id)
        from (
            (
                select PROC_INST_ID as id
                from rm_task_info ta
                left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
                where 1=1
                <if test="vo.searchTwo!=null and vo.searchTwo!=''">
                    and ta.LAUNCH_PERSON = #{vo.searchTwo}
                </if>
                <if test="vo.venues!=null and vo.venues!=''">
                    and ve.VENUES_NAME LIKE CONCAT('%',#{vo.venues},'%')
                </if>
                <if test="vo.searchOne!=null and vo.searchOne!=''">
                    and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
                </if>
            )
            union all
            (
                select co.PROC_INST_ID_ as id
                from act_hi_comment co
                left join rm_task_info ta on co.PROC_INST_ID_=ta.PROC_INST_ID
                left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
                where 1=1
                <if test="vo.searchTwo!=null and vo.searchTwo!=''">
                    and co.USER_ID_ = #{vo.searchTwo}
                </if>
                <if test="vo.venues!=null and vo.venues!=''">
                    and ve.VENUES_NAME LIKE CONCAT('%',#{vo.venues},'%')
                </if>
                <if test="vo.searchOne!=null and vo.searchOne!=''">
                    and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
                </if>
            )union all(
                select ac.PROC_INST_ID_ as id
                from act_hi_actinst ac
                left join rm_task_info ta on ac.PROC_INST_ID_=ta.PROC_INST_ID
                left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
                where  ac.END_TIME_ is null
                <if test="vo.searchTwo!=null and vo.searchTwo!=''">
                    and ac.ASSIGNEE_ = #{vo.searchTwo}
                </if>
                <if test="vo.venues!=null and vo.venues!=''">
                    and ve.VENUES_NAME LIKE CONCAT('%',#{vo.venues},'%')
                </if>
                <if test="vo.searchOne!=null and vo.searchOne!=''">
                    and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
                </if>
        )
        ) al
    </select>

    <update id="updateHiActinst">
        update act_hi_actinst set ASSIGNEE_=#{assignee}
        where ACT_TYPE_='startEvent'
        and PROC_INST_ID_=#{procInstId}
    </update>

    <select id="getTaskDetail" resultType="map">
        SELECT
            ta.TASK_NAME as taskName,
            ve.VENUES_NAME as venuesName,
            ve.VENUES_ADDRES as venuesAddres,
            DATE_FORMAT(ta.LAUNCH_TIME,'%Y-%m-%d %H:%i:%s') as taskTime,
            DATE_FORMAT(ta.END_TIME,'%Y-%m-%d %H:%i:%s') as endTime,
            FLOW_TYPE as flowType,
            case when us.USER_NM is not null then us.USER_NM else ma.MANAGER_CN_NM end as launchPerson,
            case when ta.HANDLE_RESULTS is null then '0' else ta.HANDLE_RESULTS end as handleResults,
            ta.TASK_CONTENT  as taskContent,
            case ta.EMERGENCY_LEVEL when '01' then '紧急' when '02' then '普通' else ta.EMERGENCY_LEVEL end as emeLevelCn,
            ta.EMERGENCY_LEVEL as emeLevel,
            ta.LAUNCH_PERSON as launchMobil,
            '330000' as province,
            '330300' as city,
            us.area as area,
            case  ta.REL_VENUES_ID!=us.area
            when ta.REL_VENUES_ID=ve.VENUES_ID then ve.town
            when ve.VENUES_ID is null then ta.REL_VENUES_ID
            else ''
            end as town,
            ta.REL_EVENT_ID as eventId,
            ta.TASK_PICTURE as taskPicture,
            case when ac.END_TIME_ is null then '0' else '1' end as handleFlag

        FROM rm_task_info ta
        left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
        left join act_hi_actinst ac on ac.PROC_INST_ID_ = ta.PROC_INST_ID AND ac.ASSIGNEE_=#{login}
        left join rm_sys_user_info us on us.USER_MOBILE=ta.LAUNCH_PERSON
        left join rm_venues_manager_info ma on ma.MANAGER_MOBILE=ta.LAUNCH_PERSON
        where 1=1
        <if test="procInstId!=null and procInstId!=''">
            and ta.PROC_INST_ID = #{procInstId}
        </if>

    </select>

    <select id="getRepairTask" resultType="map">
        SELECT  ve.VENUES_NAME as venuesName,
                ve.VENUES_ADDRES as venuesAddres,
                DATE_FORMAT(ac.START_TIME_,'%Y-%m-%d %H:%i:%s') as taskTime,
                ev.ACCESS_NUMBER as accessNumber,
                ta.PROC_INST_ID as procInstId,
                ta.HANDLE_RESULTS as handleResults
        FROM rm_task_info ta
        join act_hi_actinst ac on ac.PROC_INST_ID_ = ta.PROC_INST_ID and ac.ASSIGNEE_=#{assignee}
        left join rm_event_info ev on ta.REL_EVENT_ID=ev.EVENT_ID
        left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
        where ta.FLOW_TYPE='07'
        <if test="type!=null and type!=''">
            and ta.HANDLE_TIME is null
        </if>
        <if test="handleResults!=null and handleResults!=''">
            and ta.HANDLE_TIME is not null
            and ta.HANDLE_RESULTS=#{handleResults}
        </if>
    </select>

    <select id="getTaskByEventId" resultType="com.religion.zhiyun.task.entity.TaskEntity">
        select
             <include refid="taskColumn"/>
        FROM rm_task_info ta
        where ta.REL_EVENT_ID =#{eventId}
    </select>

    <select id="getEvTaDetail" resultType="map">
        select
            ev.EVENT_ID as eventId,
            ev.EVENT_LEVEL as eventLevel,
            ev.EVENT_TYPE as eventType
        from rm_task_info ta
        left join rm_event_info ev on ta.REL_EVENT_ID=ev.EVENT_ID
        where ta.PROC_INST_ID=#{procInstId}
    </select>


    <select id="getReportMen" resultType="String">

        select
            GROUP_CONCAT(if(us.USER_NM is not null,
            CONCAT(us.USER_NM,'(',(select r.ROLE_NM from rm_sys_role r where r.ROLE_ID=us.IDENTITY),')'),
            if(ma.MANAGER_CN_NM is not null,
            CONCAT(ma.MANAGER_CN_NM,'(场所管理人员)'),
            me.REPORT_MEN ))) as reportMens
        from rm_event_report_men me
        left join rm_sys_user_info us on me.REPORT_MEN =us.USER_MOBILE
        left join rm_venues_manager_info ma on ma.MANAGER_MOBILE=us.USER_MOBILE
        where me.PROC_INST_ID=#{procInstId}

    </select>

    <select id="getSubmitEvent" resultType="com.religion.zhiyun.interfaces.entity.minzong.SubmitEntity">
        SELECT
            ta.TASK_NAME as title,
            #{login} as reporterPhone,
            (select us.USER_NM from rm_sys_user_info us where us.USER_MOBILE=#{login}) as reporterName,
            ve.Latitude as latitude,
            ve.longitude as longitude,
            ve.CITY as citycode,
            ve.AREA as adcode,
            ve.TOWN as towncode,
            ve.VENUES_ADDRES as detailedAddress,
            ta.LAUNCH_TIME as occurTime,
            ta.FLOW_TYPE as flowType
        FROM rm_task_info ta
        left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
        where ta.PROC_INST_ID =#{procInstId}
    </select>

    <select id="getUnHandleTask" resultType="map">
        SELECT
        ta.TASK_NAME as taskName,
        case when ve.VENUES_NAME is not null then ve.VENUES_NAME
        else ''
        end as venuesName,
        case when ve.VENUES_ADDRES is not null then ve.VENUES_ADDRES
        else ''
        end as venuesAddres,
        '待完成' as statTask,
        ta.PROC_INST_ID as procInstId,
        DATE_FORMAT(ta.LAUNCH_TIME,'%Y-%m-%d %H:%i:%s') as taskTime,
        case ta.EMERGENCY_LEVEL when '01' then '紧急' when '02' then '普通' else ta.EMERGENCY_LEVEL end as emeLevelCn,
        if(u.USER_NM is not null, u.USER_NM,if(m.MANAGER_CN_NM is not null,m.MANAGER_CN_NM,ta.LAUNCH_PERSON )) as launchPerson,
        TASK_CONTENT as taskContent
        FROM rm_task_info ta
        <if test="vo.searchTwo!=null and vo.searchTwo!=''">
            join  act_hi_actinst ac on ac.PROC_INST_ID_ = ta.PROC_INST_ID and ac.END_TIME_ is null and ac.ASSIGNEE_= #{vo.searchTwo}
        </if>
        left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
        left join rm_sys_user_info u on u.USER_MOBILE=ta.LAUNCH_PERSON
        left join rm_venues_manager_info m on m.MANAGER_MOBILE=ta.LAUNCH_PERSON
        where ta.HANDLE_TIME is null
        <if test="vo.venues!=null and vo.venues!=''">
            and ve.VENUES_NAME LIKE CONCAT('%',#{vo.venues},'%')
        </if>
        <if test="vo.searchOne!=null and vo.searchOne!=''">
            and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
        </if>
        order by ta.EMERGENCY_LEVEL ,ta.LAUNCH_TIME desc
        limit #{vo.page},#{vo.size}
    </select>

    <select id="getUnHandleTaskTotal" resultType="long">
        select COUNT(ta.TASK_ID)
        FROM rm_task_info ta
        <if test="vo.searchTwo!=null and vo.searchTwo!=''">
            join  act_hi_actinst ac on ac.PROC_INST_ID_ = ta.PROC_INST_ID and ac.END_TIME_ is null and ac.ASSIGNEE_= #{vo.searchTwo}
        </if>
        left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
        left join rm_sys_user_info u on u.USER_MOBILE=ta.LAUNCH_PERSON
        left join rm_venues_manager_info m on m.MANAGER_MOBILE=ta.LAUNCH_PERSON
        where ta.HANDLE_TIME is null
        <if test="vo.venues!=null and vo.venues!=''">
            and ve.VENUES_NAME LIKE CONCAT('%',#{vo.venues},'%')
        </if>
        <if test="vo.searchOne!=null and vo.searchOne!=''">
            and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
        </if>
    </select>

    <select id="getHandTask" resultType="map">
        SELECT
        ta.TASK_NAME as taskName,
        case when ve.VENUES_NAME is not null then ve.VENUES_NAME
        else ''
        end as venuesName,
        case when ve.VENUES_ADDRES is not null then ve.VENUES_ADDRES
        else ''
        end as venuesAddres,
        case when ta.HANDLE_TIME is null then '未结束'
        else '已结束'
        end as statTask,
        ta.PROC_INST_ID as procInstId,
        DATE_FORMAT(ta.LAUNCH_TIME,'%Y-%m-%d %H:%i:%s') as taskTime,
        case ta.EMERGENCY_LEVEL when '01' then '紧急' when '02' then '普通' else ta.EMERGENCY_LEVEL end as emeLevelCn,
        if(u.USER_NM is not null, u.USER_NM,if(m.MANAGER_CN_NM is not null,m.MANAGER_CN_NM,ta.LAUNCH_PERSON )) as launchPerson,
        TASK_CONTENT as taskContent
        FROM rm_task_info ta
        left join act_hi_comment  co on  ta.PROC_INST_ID=co.PROC_INST_ID_
        left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
        left join rm_sys_user_info u on u.USER_MOBILE=ta.LAUNCH_PERSON
        left join rm_venues_manager_info m on m.MANAGER_MOBILE=ta.LAUNCH_PERSON
        where  (ta.LAUNCH_PERSON=#{vo.searchTwo} or co.USER_ID_=#{vo.searchTwo})
        <if test="vo.searchThree!=null and vo.searchThree!=''">
            and ta.HANDLE_TIME is null
        </if>
        <if test="vo.searchFour!=null and vo.searchFour!=''">
            and ta.HANDLE_TIME is not null
        </if>
        <if test="vo.venues!=null and vo.venues!=''">
            and ve.VENUES_NAME LIKE CONCAT('%',#{vo.venues},'%')
        </if>
        <if test="vo.searchOne!=null and vo.searchOne!=''">
            and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
        </if>
        order by ta.EMERGENCY_LEVEL ,ta.LAUNCH_TIME desc
        limit #{vo.page},#{vo.size}
    </select>

    <select id="getHandTaskTotal" resultType="long">
        select COUNT(ta.TASK_ID)
        FROM rm_task_info ta
        left join act_hi_comment  co on  ta.PROC_INST_ID=co.PROC_INST_ID_
        left join rm_venues_info ve on ve.VENUES_ID=ta.REL_VENUES_ID
        left join rm_sys_user_info u on u.USER_MOBILE=ta.LAUNCH_PERSON
        left join rm_venues_manager_info m on m.MANAGER_MOBILE=ta.LAUNCH_PERSON
        where  (ta.LAUNCH_PERSON=#{vo.searchTwo} or co.USER_ID_=#{vo.searchTwo})
        <if test="vo.searchThree!=null and vo.searchThree!=''">
            and ta.HANDLE_TIME is null
        </if>
        <if test="vo.searchFour!=null and vo.searchFour!=''">
            and ta.HANDLE_TIME is not null
        </if>
        <if test="vo.venues!=null and vo.venues!=''">
            and ve.VENUES_NAME LIKE CONCAT('%',#{vo.venues},'%')
        </if>
        <if test="vo.searchOne!=null and vo.searchOne!=''">
            and ta.TASK_NAME LIKE CONCAT('%',#{vo.searchOne},'%')
        </if>
    </select>

</mapper>
